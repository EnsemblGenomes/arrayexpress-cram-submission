# arrayexpress-cram-submission
[![Build Status](https://travis-ci.org/EnsemblGenomes/arrayexpress-cram-submission.svg?branch=master)](https://travis-ci.org/EnsemblGenomes/arrayexpress-cram-submission)

A python pipeline for submitting [CRAM](http://www.ebi.ac.uk/ena/software/cram-toolkit) files generated by
[ArrayExpress](https://www.ebi.ac.uk/arrayexpress/) to the  [European Nucleotide Archive](http://www.ebi.ac.uk/ena) (ENA).

## Installation
Get a copy of the project and install python dependencies with `pip install -r requirements.txt`

## Submitting all CRAM files for a species
```bash
export ena_user=webin-xxx
export ena_password=xxxxxxxx
luigi --module pipeline SubmitSpecies --species oryza_sativa --local-scheduler
```

 This will
 1. call the ArrayExpress API to fetch a list of all Oryza sativa CRAM files which have been marked as 'Complete'
 2. upload each CRAM file to the European Nucleotide Archive (ENA)
 3. collect metadata required for the submission
 4. create 'submission' and 'analysis' XML documents required for [programmatic submission](http://www.ebi.ac.uk/ena/submit/programmatic-submission)
 to the ENA and submit
 5. store the resulting submission and analysis accessions in an SQLite database

 ... more to come

 ## Background
Every step from discovering CRAM files, over collecting metadata, to submitting to ENA is implemented as a
[luigi](https://github.com/spotify/luigi) [Task](http://luigi.readthedocs.io/en/stable/tasks.html).

This makes it easy to deal with failures that inevitably will happen when e.g. some of 30k+ long running tasks that have
dependencies between each other will fail. Instead of cleaning up after failed tasks, resetting state, or being forced to
 start again from scratch we can rely on luigi to check the completion of (atomic) tasks and safely resume.
